<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>KotakEngine Chat</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

body, html {
  margin:0; padding:0; height:100%; 
  font-family: 'Roboto', 'Segoe UI', Helvetica, Arial, sans-serif;
  background:#f7f7f7;
}

#topBar {
  height:50px; background:#0088cc; color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-weight:bold; position:relative;
}

#profileBtn { position:absolute; left:10px; cursor:pointer; }

#profilePanel {
  display:none; position:absolute; top:50px; left:0; width:250px;
  background:#fff; border:1px solid #ccc; padding:10px; z-index:1000;
}

#profilePanel img { width:50px; height:50px; border-radius:50%; margin-bottom:10px; }
#profilePanel button { width:100%; margin-top:10px; padding:5px; border:none; border-radius:4px; background:#0088cc; color:#fff; cursor:pointer; }

#loginScreen, #mainScreen {
  width:100%; height:calc(100% - 50px); display:flex; flex-direction:column; align-items:center; justify-content:center;
}

#mainScreen { display:none; }

#chatContainer { display:flex; width:100%; height:100%; }

#leftPanel { width:25%; border-right:1px solid #ccc; display:flex; flex-direction:column; background:#fff; position:relative; }
#rightPanel { flex:1; display:flex; flex-direction:column; }

#chatHeader { padding:10px; border-bottom:1px solid #ccc; background:#f0f0f0; font-weight:bold; display:flex; align-items:center; }

#chatMessages { flex:1; padding:10px; overflow-y:auto; background:#fafafa; }

#chatInput { display:flex; padding:5px; border-top:1px solid #ccc; background:#f0f0f0; }
#chatInput input { flex:1; padding:5px; border:1px solid #ccc; border-radius:4px; }
#chatInput button { padding:5px 10px; margin-left:5px; border:none; border-radius:4px; background:#0088cc; color:#fff; cursor:pointer; }

.userItem { padding:10px; border-bottom:1px solid #eee; cursor:pointer; display:flex; align-items:center; }
.userItem img { width:30px; height:30px; border-radius:50%; margin-right:10px; }
.userItem:hover { background:#eee; }

#searchContainer { display:none; flex-direction:column; padding:10px; }
#searchContainer input { padding:5px; margin-bottom:5px; border:1px solid #ccc; border-radius:4px; }

#chatList { flex:1; overflow-y:auto; }

.messageRow {
  display:flex;
  align-items:flex-start;
  margin-bottom:5px;
}

.messageRow .senderName {
  width:90px; font-weight:bold; color:#0088cc;
  display:flex; align-items:center;
}

.messageRow .senderName img {
  width:30px; height:30px; border-radius:50%; margin-right:5px;
}

.messageRow .messageText { flex:1; word-break: break-word; }

</style>
</head>
<body>

<div id="topBar">
  <div id="profileBtn">‚ò∞</div>
  KotakEngine
</div>

<div id="profilePanel">
  <img id="profilePic" src="" alt="Profilovka">
  <div id="profileName"></div>
  <div id="profileEmail"></div>
  <input type="file" id="uploadPic"><br><br>
  <button id="panelLogoutBtn">Odhl√°sit se</button>
</div>

<!-- Login Screen -->
<div id="loginScreen">
  <h2>üî• P≈ôihl√°≈°en√≠ do chatu</h2>
  <div id="registerForm">
    <input type="text" id="regName" placeholder="Jm√©no" required><br>
    <input type="email" id="regEmail" placeholder="Email" required><br>
    <input type="password" id="regPass" placeholder="Heslo" required><br>
    <button id="regBtn">Registrovat</button>
  </div>
  <div id="loginForm" style="margin-top:10px;">
    <input type="email" id="loginEmail" placeholder="Email" required><br>
    <input type="password" id="loginPass" placeholder="Heslo" required><br>
    <button id="loginBtn">P≈ôihl√°sit se</button>
  </div>
</div>

<!-- Main Screen -->
<div id="mainScreen">
  <div style="display:flex; width:100%; height:100%;">
    <div id="leftPanel">
      <button id="newChatBtn">Zah√°jit chat</button>
      <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Vyhledej u≈æivatele">
        <div id="searchResults"></div>
      </div>
      <div id="chatList"></div>
    </div>
    <div id="rightPanel">
      <div id="chatHeader">Vyber chat</div>
      <div id="chatMessages"></div>
      <div id="chatInput">
        <input type="text" id="msgInput" placeholder="Napi≈° zpr√°vu...">
        <button id="sendBtn">Odeslat</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD96lOIJjN9_aFMlstYbx4aUaH_xwjtK8s",
  authDomain: "chat-a99ee.firebaseapp.com",
  projectId: "chat-a99ee",
  storageBucket: "chat-a99ee.appspot.com",
  messagingSenderId: "558124959244",
  appId: "1:558124959244:web:e603b56a1fbd9c2d12d029",
  measurementId: "G-2C6T31PMGS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null, currentChatId = null, currentChatName = null;

// Persistent login
window.onload = () => {
  const savedUser = localStorage.getItem("currentUser");
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    db.ref("users/" + currentUser.id).once("value", snap => {
      const data = snap.val();
      currentUser = { id: currentUser.id, name: data.name, email: data.email, photo: data.photo||"" };
      showMainScreen();
    });
  }
};

// Registrace
document.getElementById("regBtn").onclick = () => {
  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  if (!name || !email || !pass) { alert("Vypl≈à v≈°echna pole"); return; }

  db.ref("users").orderByChild("email").equalTo(email).once("value", snap => {
    if (snap.exists()) { alert("Email u≈æ existuje"); return; }
    const newUserRef = db.ref("users").push();
    newUserRef.set({ name, email, password: pass, photo: "" });
    alert("Registrace √∫spƒõ≈°n√°! P≈ôihla≈° se.");
  });
};

// Login
document.getElementById("loginBtn").onclick = () => {
  const email = document.getElementById("loginEmail").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  if (!email || !pass) { alert("Vypl≈à email i heslo"); return; }

  db.ref("users").orderByChild("email").equalTo(email).once("value", snap => {
    if (!snap.exists()) { alert("Email nenalezen"); return; }
    let found = false;
    snap.forEach(child => {
      const data = child.val();
      if (data.password === pass) {
        currentUser = { id: child.key, name: data.name, email: data.email, photo: data.photo||"" };
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        showMainScreen();
        found = true;
      }
    });
    if (!found) alert("≈†patn√© heslo");
  });
};

// Show main screen
function showMainScreen() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "flex";
  document.getElementById("profileName").innerText = currentUser.name;
  document.getElementById("profileEmail").innerText = currentUser.email;
  document.getElementById("profilePic").src = currentUser.photo || "https://via.placeholder.com/50";
  loadChatList();
}

// Logout
document.getElementById("panelLogoutBtn").onclick = () => {
  currentUser = null;
  localStorage.removeItem("currentUser");
  document.getElementById("mainScreen").style.display = "none";
  document.getElementById("loginScreen").style.display = "flex";
};

// Profile panel toggle
const profileBtn = document.getElementById("profileBtn");
const profilePanel = document.getElementById("profilePanel");
profileBtn.onclick = (e) => { e.stopPropagation(); profilePanel.style.display = profilePanel.style.display === "block" ? "none" : "block"; }
document.body.addEventListener("click", () => { profilePanel.style.display = "none"; });
profilePanel.addEventListener("click", e => { e.stopPropagation(); });

// Upload profile pic
document.getElementById("uploadPic").onchange = (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const url = evt.target.result;
    db.ref("users/" + currentUser.id).update({ photo: url });
    currentUser.photo = url;
    document.getElementById("profilePic").src = url;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  };
  reader.readAsDataURL(file);
};

// Chat list
function loadChatList() {
  const chatListDiv = document.getElementById("chatList"); chatListDiv.innerHTML = "";
  db.ref("privateChats").once("value", snap => {
    snap.forEach(chatSnap => {
      const chatId = chatSnap.key;
      if (chatId.includes(currentUser.id)) {
        const otherId = chatId.replace(currentUser.id + "_", "").replace("_" + currentUser.id, "");
        db.ref("users/" + otherId).once("value", uSnap => {
          const userName = uSnap.val()?.name || "Nezn√°m√Ω";
          const photo = uSnap.val()?.photo || "https://via.placeholder.com/30";
          const div = document.createElement("div");
          div.className = "userItem";
          div.innerHTML = `<img src="${photo}">${userName}`;
          div.onclick = () => openChat(otherId, userName);
          chatListDiv.appendChild(div);
        });
      }
    });
  });
}

// New chat search
document.getElementById("newChatBtn").onclick = () => {
  const sc = document.getElementById("searchContainer");
  sc.style.display = sc.style.display === "flex" ? "none" : "flex";
  document.getElementById("searchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
};

document.getElementById("searchInput").oninput = (e) => {
  const val = e.target.value.toLowerCase();
  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = "";
  if (!val) return;
  db.ref("users").once("value", snap => {
    snap.forEach(uSnap => {
      const data = uSnap.val();
      if (data.name.toLowerCase().includes(val) && uSnap.key !== currentUser.id) {
        const div = document.createElement("div");
        div.className = "userItem";
        const photo = data.photo || "https://via.placeholder.com/30";
        div.innerHTML = `<img src="${photo}">${data.name}`;
        div.onclick = () => {
          openChat(uSnap.key, data.name);
          document.getElementById("searchContainer").style.display = "none";
        };
        resultsDiv.appendChild(div);
      }
    });
  });
};

// Open chat
function openChat(otherId, otherName) {
  if (otherId === currentUser.id) { alert("Nem≈Ø≈æe≈° si ps√°t s√°m sobƒõ!"); return; }
  const ids = [currentUser.id, otherId].sort();
  currentChatId = ids.join("_");
  currentChatName = otherName;
  document.getElementById("chatHeader").innerText = otherName;
  document.getElementById("chatMessages").innerHTML = "";
  loadMessages();
}

// Send message
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("msgInput").addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
function sendMessage() {
  const text = document.getElementById("msgInput").value.trim();
  if (!text || !currentChatId) return;
  db.ref("privateChats/" + currentChatId + "/messages").push({
    from: currentUser.id,
    text: text,
    ts: Date.now()
  });
  document.getElementById("msgInput").value = "";
}

// Load messages
function loadMessages() {
  const msgDiv = document.getElementById("chatMessages");
  msgDiv.innerHTML = "";

  const messages = [];

  function renderMessages() {
    msgDiv.innerHTML = "";
    messages.sort((a, b) => a.ts - b.ts);
    messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "messageRow";

      if (msg.from === currentUser.id) {
        div.innerHTML = `<div class="senderName"><img src="${currentUser.photo||'https://via.placeholder.com/30'}">${currentUser.name}</div>
                         <div class="messageText">${msg.text}</div>`;
        msgDiv.appendChild(div);
      } else {
        if (!msg.photo) {
          db.ref("users/" + msg.from).once("value").then(uSnap => {
            const uData = uSnap.val();
            msg.photo = uData.photo || "https://via.placeholder.com/30";
            msg.name = uData.name || "Nezn√°m√Ω";
            renderMessages();
          });
        } else {
          div.innerHTML = `<div class="senderName"><img src="${msg.photo}">${msg.name}</div>
                           <div class="messageText">${msg.text}</div>`;
          msgDiv.appendChild(div);
        }
      }
    });
    msgDiv.scrollTop = msgDiv.scrollHeight;
  }

  // Naƒç√≠st existuj√≠c√≠ zpr√°vy
  db.ref("privateChats/" + currentChatId + "/messages").once("value").then(snap => {
    snap.forEach(child => {
      messages.push({ id: child.key, ...child.val() });
    });
    renderMessages();
  });

  // Live listener na nov√© zpr√°vy
  db.ref("privateChats/" + currentChatId + "/messages").on("child_added", snap => {
    const msg = { id: snap.key, ...snap.val() };
    if (!messages.find(m => m.id === msg.id)) {
      messages.push(msg);
      renderMessages();
    }
  });
}

</script>

</body>
</html>
